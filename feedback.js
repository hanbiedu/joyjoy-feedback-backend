// === line1, line2ë¥¼ feedback_items.jsonì—ì„œ ì½ì–´ì„œ HTMLì— ì±„ìš°ëŠ” í•¨ìˆ˜ë“¤ ===
async function loadActivityLines() {
  try {
    const res = await fetch("items/feedback_items.json", { cache: "no-cache" });
    if (!res.ok) {
      console.error("âŒ feedback_items.json ìš”ì²­ ì‹¤íŒ¨:", res.status, res.statusText);
      return;
    }

    const data = await res.json();
    console.log("âœ… feedback_items.json ë¡œë“œ ì™„ë£Œ:", data);

    fillActivity("item1", data.item1);
    fillActivity("item2", data.item2);
    fillActivity("item3", data.item3);
    fillActivity("item4", data.item4);
    fillActivity("item5", data.item5);
    fillActivity("item6", data.item6);
  } catch (err) {
    console.error("âŒ feedback_items.json ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜:", err);
  }
}

function fillActivity(itemKey, itemData) {
  if (!itemData) return;

  const line1El = document.getElementById(`${itemKey}-line1`);
  const line2El = document.getElementById(`${itemKey}-line2`);

  if (line1El) line1El.textContent = itemData.line1 || "";
  if (line2El) line2El.textContent = itemData.line2 || "";

  const optionsContainer = document.getElementById(`${itemKey}-options`);
  if (optionsContainer && itemData.options) {
    optionsContainer.innerHTML = generateRadioButtons(itemKey, itemData.options);
  }
}

function generateRadioButtons(name, options) {
  let html = "";

  options.forEach((opt, i) => {
    const id = `${name}-option-${opt.value}`;
    html += `
      <label for="${id}">
        <input type="radio" name="${name}" value="${opt.value}" id="${id}" ${i === 0 ? "checked" : ""}>
        ${opt.label}
      </label><br>
    `;
  });

  return html;
}

// ===================================================================
// DOM LOAD
// ===================================================================
document.addEventListener("DOMContentLoaded", () => {
  console.log("feedback.js loaded!");
  loadActivityLines();

  const form = document.getElementById("feedbackForm");
  const autoBtn = document.getElementById("autoGenerateBtn");
  const autoTextArea = document.getElementById("autoGeneratedText");

  const BACKEND_URL = "https://joyjoy-feedback-backend.onrender.com";

  if (!form) return;

  // ===============================================================
  // 1) AI ìë™ ìƒì„± ë²„íŠ¼ í´ë¦­
  // ===============================================================
  autoBtn?.addEventListener("click", async (e) => {
    e.preventDefault();
    console.log("ğŸ¤– AI ìë™ ìƒì„± í´ë¦­!");

    // ğŸ”¥ ì„ íƒëœ valueë¥¼ items ë°°ì—´ì— ë‹´ê¸° (í•µì‹¬ ìˆ˜ì •)
    const itemsArray = [
      { id: 1, value: form.item1?.value || "" },
      { id: 2, value: form.item2?.value || "" },
      { id: 3, value: form.item3?.value || "" },
      { id: 4, value: form.item4?.value || "" },
      { id: 5, value: form.item5?.value || "" },
      { id: 6, value: form.item6?.value || "" }
    ];

    const payload = {
      childName: form.childName?.value || "",
      ageMonth: Number(form.ageMonth?.value || 0),
      items: itemsArray
    };

    console.log("ğŸ“¤ AI ìë™ ìƒì„± payload:", payload);

    try {
      const autoRes = await fetch(`${BACKEND_URL}/api/auto-feedback`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const raw = await autoRes.text();
      let autoResult;

      try {
        autoResult = JSON.parse(raw);
      } catch (e) {
        console.error("JSON íŒŒì‹± ì‹¤íŒ¨:", e);
        alert("AI ì‘ë‹µì„ í•´ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const finalText =
        autoResult.autoText ||
        autoResult.backupText ||
        "ì˜¤ëŠ˜ì˜ í”¼ë“œë°± ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";

      if (autoTextArea) autoTextArea.value = finalText;

      // ì €ì¥ìš© ë°ì´í„° êµ¬ì„±
      const saveData = {
        ...payload,
        autoText: finalText
      };

      console.log("ğŸ“¤ ì €ì¥ìš© saveData:", saveData);

      await fetch(`${BACKEND_URL}/api/feedback`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(saveData)
      });

      alert("AI ìë™ ìƒì„± + ì €ì¥ ì™„ë£Œ!");

    } catch (err) {
      console.error("AI ìë™ ìƒì„± ì˜¤ë¥˜:", err);
      alert("AI ìë™ ìƒì„± ì¤‘ ì˜¤ë¥˜");
    }
  });
});
