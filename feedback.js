// === line1, line2, optionsë¥¼ "ì›”ë³„ í‰ê°€í•­ëª© JSON(ì˜ˆ: items/item12.json)"ì—ì„œ ì½ê³ ,
// ê·¸ ì•ˆì˜ "ì£¼ì°¨(ì˜ˆ: week1)"ë¥¼ ì„ íƒí•´ HTMLì— ì±„ìš°ëŠ” í•¨ìˆ˜ë“¤ ===
//
// URL ì˜ˆì‹œ:
// - feedback.html?lesson=12-1        (ì¶”ì²œ: month-week í•œë²ˆì—)
// - feedback.html?month=12&week=1
// - (ê³¼ê±° í˜¸í™˜) feedback.html?items=12-1
// - week=week1 í˜•íƒœë„ í—ˆìš© (ì˜ˆ: ?month=12&week=week1)
//
// íŒŒì¼ëª… ê·œì¹™(ê¸°ë³¸): items/item{month}.json  (ì˜ˆ: items/item12.json)

function getMonthWeekFromUrl() {
  const p = new URLSearchParams(window.location.search);

  // 1) ?lesson=12-1  ë˜ëŠ” ?items=12-1 (legacy)
  const lessonLike = p.get("lesson") || p.get("items");
  if (lessonLike) {
    const parts = String(lessonLike).split("-");
    const month = parts[0] || "12";
    const weekNum = parts[1] || "1";
    const w = String(weekNum).startsWith("week") ? String(weekNum).replace("week", "") : String(weekNum);
    return { month, weekKey: `week${w}`, weekNum: w };
  }

  // 2) ?month=12&week=1  ë˜ëŠ” ?month=12&week=week1
  const month = p.get("month") || "12";
  const weekRaw = p.get("week") || "1";
  const w = String(weekRaw).startsWith("week") ? String(weekRaw).replace("week", "") : String(weekRaw);

  return { month, weekKey: `week${w}`, weekNum: w };
}

function buildMonthlyItemsPathCandidates(month) {
  const m = String(month);
  // ìš°ì„ ìˆœìœ„: items/item12.json -> item12.json -> items/feedback_items.json(ë§ˆì§€ë§‰ fallback)
  return [
    `items/item${m}.json`,
    `item${m}.json`,
    `items/feedback_items.json`,
  ];
}

async function loadActivityLines() {
  const { month, weekKey } = getMonthWeekFromUrl(); // ì˜ˆ: { month:"12", weekKey:"week1" }
  const candidates = buildMonthlyItemsPathCandidates(month);

  try {
    let res = null;
    let usedPath = null;

    for (const p of candidates) {
      const r = await fetch(p, { cache: "no-cache" });
      if (r.ok) {
        res = r;
        usedPath = p;
        break;
      }
    }

    if (!res) {
      console.error("âŒ ì›”ë³„ í‰ê°€í•­ëª© JSON ìš”ì²­ ì‹¤íŒ¨(ëª¨ë“  í›„ë³´ ê²½ë¡œ):", candidates.join(", "));
      return;
    }

    const data = await res.json();

    // ì›”ë³„ í‰ê°€í•­ëª© JSON(item12.json) êµ¬ì¡°: { week1: { item1..item6 }, week2: ... } îˆ€fileciteîˆ‚turn2file0îˆ
    const weekData = data?.[weekKey];

    // ë§ˆì§€ë§‰ fallback(items/feedback_items.json)ì¼ ìˆ˜ë„ ìˆì–´ì„œ ë‘ ì¼€ì´ìŠ¤ ëª¨ë‘ ì§€ì›
    const itemsObj = weekData || data;

    if (!itemsObj?.item1) {
      console.error("âŒ ì£¼ì°¨ ë°ì´í„°/ì•„ì´í…œ êµ¬ì¡°ë¥¼ ì°¾ì§€ ëª»í•¨:", { month, weekKey, usedPath });
      return;
    }

    // ì œëª©ì€ JSONì— ì—†ìœ¼ë‹ˆ URL ê¸°ì¤€ìœ¼ë¡œ ìƒì„±
    if (typeof setLessonTitle === "function") setLessonTitle(`${month}ì›” ${weekKey}`);

    fillActivity("item1", itemsObj.item1);
    fillActivity("item2", itemsObj.item2);
    fillActivity("item3", itemsObj.item3);
    fillActivity("item4", itemsObj.item4);
    fillActivity("item5", itemsObj.item5);
    fillActivity("item6", itemsObj.item6);
  } catch (err) {
    console.error("âŒ ì›”ë³„ í‰ê°€í•­ëª© JSON ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜:", err);
  }
}


function fillActivity(itemKey, itemData) {
  if (!itemData) return;

  const line1El = document.getElementById(`${itemKey}-line1`);
  const line2El = document.getElementById(`${itemKey}-line2`);

  if (line1El) line1El.textContent = itemData.line1 || "";
  if (line2El) line2El.textContent = itemData.line2 || "";

  const optionsContainer = document.getElementById(`${itemKey}-options`);
  if (optionsContainer && itemData.options) {
    optionsContainer.innerHTML = generateRadioButtons(itemKey, itemData.options);
  }
}

function generateRadioButtons(name, options) {
  let html = "";

  options.forEach((opt, i) => {
    const id = `${name}-option-${opt.value}`;
    html += `
      <label for="${id}">
        <input type="radio" name="${name}" value="${opt.value}" id="${id}" ${i === 0 ? "checked" : ""}>
        ${opt.label}
      </label><br>
    `;
  });

  return html;
}

// ===================================================================
// DOM LOAD
// ===================================================================
document.addEventListener("DOMContentLoaded", () => {
  console.log("feedback.js loaded!");
  loadActivityLines();

  const form = document.getElementById("feedbackForm");
  const autoBtn = document.getElementById("autoGenerateBtn");
  const autoTextArea = document.getElementById("autoGeneratedText");

  const BACKEND_URL = "https://joyjoy-feedback-backend.onrender.com";

  if (!form) return;

  // ===============================================================
  // 1) AI ìë™ ìƒì„± ë²„íŠ¼ í´ë¦­
  // ===============================================================
  autoBtn?.addEventListener("click", async (e) => {
    e.preventDefault();
    console.log("ğŸ¤– AI ìë™ ìƒì„± í´ë¦­!");

    // ğŸ”¥ ì„ íƒëœ valueë¥¼ items ë°°ì—´ì— ë‹´ê¸° (í•µì‹¬ ìˆ˜ì •)
    const itemsArray = [
      { id: 1, value: form.item1?.value || "" },
      { id: 2, value: form.item2?.value || "" },
      { id: 3, value: form.item3?.value || "" },
      { id: 4, value: form.item4?.value || "" },
      { id: 5, value: form.item5?.value || "" },
      { id: 6, value: form.item6?.value || "" }
    ];

    const payload = {
      childName: form.childName?.value || "",
      ageMonth: Number(form.ageMonth?.value || 0),
      items: itemsArray
    };

    console.log("ğŸ“¤ AI ìë™ ìƒì„± payload:", payload);

    try {
      const autoRes = await fetch(`${BACKEND_URL}/api/auto-feedback`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const raw = await autoRes.text();
      let autoResult;

      try {
        autoResult = JSON.parse(raw);
      } catch (e) {
        console.error("JSON íŒŒì‹± ì‹¤íŒ¨:", e);
        alert("AI ì‘ë‹µì„ í•´ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const finalText =
        autoResult.autoText ||
        autoResult.backupText ||
        "ì˜¤ëŠ˜ì˜ í”¼ë“œë°± ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";

      if (autoTextArea) autoTextArea.value = finalText;

      // ì €ì¥ìš© ë°ì´í„° êµ¬ì„±
      const saveData = {
        ...payload,
        autoText: finalText
      };

      console.log("ğŸ“¤ ì €ì¥ìš© saveData:", saveData);

      await fetch(`${BACKEND_URL}/api/feedback`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(saveData)
      });

      alert("AI ìë™ ìƒì„± + ì €ì¥ ì™„ë£Œ!");

    } catch (err) {
      console.error("AI ìë™ ìƒì„± ì˜¤ë¥˜:", err);
      alert("AI ìë™ ìƒì„± ì¤‘ ì˜¤ë¥˜");
    }
  });
});
